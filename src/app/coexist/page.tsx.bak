'use client';

import { useState, useEffect } from 'react';
import Link from 'next/link';
import { Card } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Textarea } from '@/components/ui/textarea';
import { Sidebar } from '@/components/sidebar';
import { useNavigationBack } from '@/hooks/use-navigation-back';
import {
  getRelationshipRecords,
  addRelationshipRecord,
  deleteRelationshipRecord,
  RelationshipRecord,
} from '@/lib/storage';

export default function CoexistPage() {
  const { handleBack } = useNavigationBack('/');
  const [personName, setPersonName] = useState('');
  const [relationshipType, setRelationshipType] = useState('');
  const [currentStatus, setCurrentStatus] = useState('');
  const [content, setContent] = useState('');
  const [records, setRecords] = useState<RelationshipRecord[]>([]);
  const [showFeedback, setShowFeedback] = useState(false);

  // ä» localStorage åŠ è½½è®°å½•
  useEffect(() => {
    const loadedRecords = getRelationshipRecords();
    setRecords(loadedRecords);
  }, []);

  // ä¿å­˜å…³ç³»è®°å½•
  const handleSave = () => {
    if (!personName.trim()) return;

    const newRecord: RelationshipRecord = {
      id: Date.now().toString(),
      type: 'relationship',
      personName: personName.trim(),
      relationshipType: relationshipType.trim(),
      currentStatus: currentStatus.trim(),
      content: content.trim(),
      createdAt: new Date(),
    };

    addRelationshipRecord(newRecord);
    setRecords((prev) => [newRecord, ...prev]);

    // æ˜¾ç¤ºåé¦ˆ
    setShowFeedback(true);

    // æ¸…ç©ºè¡¨å•
    setPersonName('');
    setRelationshipType('');
    setCurrentStatus('');
    setContent('');

    // 3ç§’åéšè—åé¦ˆ
    setTimeout(() => {
      setShowFeedback(false);
    }, 3000);
  };

  // åˆ é™¤è®°å½•
  const handleDelete = (id: string) => {
    deleteRelationshipRecord(id);
    setRecords((prev) => prev.filter((r) => r.id !== id));
  };

  // æ ¼å¼åŒ–æ—¥æœŸ
  const formatDate = (date: Date) => {
    const now = new Date();
    const diff = now.getTime() - date.getTime();
    const days = Math.floor(diff / (1000 * 60 * 60 * 24));

    if (days === 0) return 'ä»Šå¤©';
    if (days === 1) return 'æ˜¨å¤©';
    if (days < 7) return `${days}å¤©å‰`;
    return date.toLocaleDateString('zh-CN');
  };

  return (
    <div className="min-h-screen bg-background text-foreground">
      <Sidebar />

      <main className="ml-64">
        {/* Header */}
        <header className="sticky top-0 z-40 glass border-b border-[#e5e5e5] dark:border-[#38383a]">
          <div className="max-w-4xl mx-auto px-8 py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center gap-4">
                {/* è¿”å›æŒ‰é’® */}
                <Button
                  variant="ghost"
                  size="sm"
                  className="text-[#86868b] hover:text-[#1d1d1f] dark:hover:text-[#f5f5f7] h-8 px-2"
                  onClick={handleBack}
                >
                  â† è¿”å›
                </Button>

                {/* æ ‡é¢˜ */}
                <div>
                  <h1 className="text-2xl font-semibold text-[#1d1d1f] dark:text-[#f5f5f7]">
                    å…±ç”Ÿ Co-exist
                  </h1>
                  <p className="text-sm text-[#86868b] mt-1">
                    å…³ç³»ä¸ç›¸å¤„æ–¹å¼çš„æ¾„æ¸…
                  </p>
                </div>
              </div>
            </div>
          </div>
        </header>

        <div className="max-w-4xl mx-auto px-8 py-8 space-y-8">
          {/* å…³ç³»è®°å½•è¾“å…¥åŒº */}
          <Card className="p-8 bg-card border-[#e5e5e5] dark:border-[#38383a] card-shadow">
            <div className="space-y-6">
              <div>
                <h2 className="text-lg font-semibold text-[#1d1d1f] dark:text-[#f5f5f7] mb-2">
                  è®°å½•ä¸€æ®µå…³ç³»
                </h2>
                <p className="text-sm text-[#86868b]">
                  å¸®åŠ©ä½ ç†è§£å…³ç³»ä¸­çš„äº’åŠ¨ç»“æ„ã€è¾¹ç•Œä¸è‡ªæˆ‘æ¶ˆè€—ç‚¹
                </p>
              </div>

              {/* å…³ç³»å¯¹è±¡ */}
              <div>
                <label className="block text-sm font-medium text-[#1d1d1f] dark:text-[#f5f5f7] mb-2">
                  å…³ç³»å¯¹è±¡ <span className="text-[#86868b]">(å¦‚ï¼šå¦ˆå¦ˆã€åŒäº‹ A)</span>
                </label>
                <input
                  type="text"
                  value={personName}
                  onChange={(e) => setPersonName(e.target.value)}
                  placeholder="è¾“å…¥å…³ç³»å¯¹è±¡åç§°"
                  className="w-full px-4 py-3 rounded-lg border border-[#e5e5e5] dark:border-[#38383a] bg-background text-[#1d1d1f] dark:text-[#f5f5f7] focus:outline-none focus:ring-2 focus:ring-[#0071e3]"
                />
              </div>

              {/* å…³ç³»ç±»å‹ */}
              <div>
                <label className="block text-sm font-medium text-[#1d1d1f] dark:text-[#f5f5f7] mb-2">
                  å…³ç³»ç±»å‹ <span className="text-[#86868b]">(å¦‚ï¼šå®¶åº­ã€æœ‹å‹ã€åŒäº‹)</span>
                </label>
                <input
                  type="text"
                  value={relationshipType}
                  onChange={(e) => setRelationshipType(e.target.value)}
                  placeholder="è¾“å…¥å…³ç³»ç±»å‹"
                  className="w-full px-4 py-3 rounded-lg border border-[#e5e5e5] dark:border-[#38383a] bg-background text-[#1d1d1f] dark:text-[#f5f5f7] focus:outline-none focus:ring-2 focus:ring-[#0071e3]"
                />
              </div>

              {/* å½“å‰çŠ¶æ€ */}
              <div>
                <label className="block text-sm font-medium text-[#1d1d1f] dark:text-[#f5f5f7] mb-2">
                  å½“å‰çŠ¶æ€ <span className="text-[#86868b]">(å¦‚ï¼šäº²å¯†ã€ç–è¿œã€å†²çª)</span>
                </label>
                <input
                  type="text"
                  value={currentStatus}
                  onChange={(e) => setCurrentStatus(e.target.value)}
                  placeholder="è¾“å…¥å½“å‰çŠ¶æ€"
                  className="w-full px-4 py-3 rounded-lg border border-[#e5e5e5] dark:border-[#38383a] bg-background text-[#1d1d1f] dark:text-[#f5f5f7] focus:outline-none focus:ring-2 focus:ring-[#0071e3]"
                />
              </div>

              {/* å…³ç³»æè¿° */}
              <div>
                <label className="block text-sm font-medium text-[#1d1d1f] dark:text-[#f5f5f7] mb-2">
                  å…³ç³»æè¿°æˆ–äº‹ä»¶ <span className="text-[#86868b]">(å¯é€‰)</span>
                </label>
                <Textarea
                  value={content}
                  onChange={(e) => setContent(e.target.value)}
                  placeholder="æè¿°è¿™æ®µå…³ç³»ä¸­çš„äº’åŠ¨æˆ–äº‹ä»¶..."
                  rows={4}
                  className="border-[#e5e5e5] dark:border-[#38383a]"
                />
              </div>

              {/* ä¿å­˜æŒ‰é’® */}
              <div className="flex items-center justify-between pt-4 border-t border-[#e5e5e5] dark:border-[#38383a]">
                <p className="text-xs text-[#86868b]">
                  æ‰€æœ‰æ•°æ®é»˜è®¤ä¿å­˜åœ¨æœ¬åœ°ï¼Œä»…ä½ å¯è§
                </p>
                <div className="flex items-center gap-3">
                  {showFeedback && (
                    <span className="text-sm text-[#0071e3] animate-in fade-in slide-in-from-bottom-2">
                      å·²ä¿å­˜
                    </span>
                  )}
                  <Button
                    className="bg-[#0071e3] hover:bg-[#0077ed]"
                    onClick={handleSave}
                    disabled={!personName.trim()}
                  >
                    ä¿å­˜
                  </Button>
                </div>
              </div>
            </div>
          </Card>

          {/* å…³ç³»è®°å½•åˆ—è¡¨ */}
          {records.length > 0 && (
            <div>
              <h3 className="text-lg font-semibold text-[#1d1d1f] dark:text-[#f5f5f7] mb-4">
                å·²è®°å½•çš„å…³ç³»
              </h3>
              <div className="space-y-4">
                {records.map((record) => (
                  <Card
                    key={record.id}
                    className="p-6 bg-card border-[#e5e5e5] dark:border-[#38383a] card-shadow"
                  >
                    <div className="space-y-3">
                      {/* æ ‡é¢˜è¡Œ */}
                      <div className="flex items-start justify-between">
                        <div className="flex-1">
                          <div className="flex items-center gap-2 mb-1">
                            <h3 className="text-base font-semibold text-[#1d1d1f] dark:text-[#f5f5f7]">
                              {record.personName}
                            </h3>
                            {record.relationshipType && (
                              <span className="px-2 py-0.5 text-xs bg-blue-100 text-blue-700 dark:bg-blue-900 dark:text-blue-300 rounded-full">
                                {record.relationshipType}
                              </span>
                            )}
                          </div>
                          <div className="flex items-center gap-2 text-xs text-[#86868b]">
                            <span>è®°å½•äº {formatDate(record.createdAt)}</span>
                            {record.currentStatus && (
                              <>
                                <span>â€¢</span>
                                <span>çŠ¶æ€ï¼š{record.currentStatus}</span>
                              </>
                            )}
                          </div>
                        </div>
                        <Button
                          variant="ghost"
                          size="sm"
                          onClick={() => handleDelete(record.id)}
                          className="text-[#86868b] hover:text-red-600 dark:hover:text-red-400"
                        >
                          åˆ é™¤
                        </Button>
                      </div>

                      {/* æè¿° */}
                      {record.content && (
                        <p className="text-sm text-[#1d1d1f] dark:text-[#f5f5f7] leading-relaxed">
                          {record.content}
                        </p>
                      )}
                    </div>
                  </Card>
                ))}
              </div>
            </div>
          )}

          {/* è¯´æ˜å¡ç‰‡ */}
          <Card className="p-6 bg-card border-[#e5e5e5] dark:border-[#38383a] card-shadow">
            <div className="text-center py-4">
              <div className="text-3xl mb-3">ğŸŒ¿</div>
              <h3 className="text-base font-semibold text-[#1d1d1f] dark:text-[#f5f5f7] mb-2">
                å…³äºå…±ç”Ÿ
              </h3>
              <p className="text-sm text-[#86868b] leading-relaxed max-w-md mx-auto">
                å…±ç”Ÿæ˜¯å…³ç³»å¯¼èˆªå·¥å…·ï¼Œå¸®åŠ©ä½ ç†è§£å…³ç³»ä¸­çš„äº’åŠ¨ç»“æ„ã€è¾¹ç•Œä¸è‡ªæˆ‘æ¶ˆè€—ç‚¹ã€‚
                <br />
                <span className="text-xs text-[#86868b] mt-2 block">
                  ä¸æ˜¯ç¤¾äº¤ã€ä¸æ˜¯èŠå¤©ã€ä¸æ˜¯å¿ƒç†è¯Šæ–­ï¼Œä»…æä¾›å…³ç³»è§†è§’ä¸ç›¸å¤„æ–¹å‘ã€‚
                </span>
              </p>
            </div>
          </Card>
        </div>
      </main>
    </div>
  );
}
